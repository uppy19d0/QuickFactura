@page "/Producto"
@using BlazorInputFile
@using Microsoft.AspNetCore.Identity
@using Examen_Final.Data
@inject NavigationManager NavigationManager
@inject ServiceProducto service
@inject ServiceUsuario service_usuario
@inject IJSRuntime JSRuntime
@inject SignInManager<Usuario> SignInManager
@inject UserManager<Usuario> UserManager
@inject IHttpContextAccessor httpContextAccessor

<AuthorizeView>
    <Authorized>
        <div class="d-flex flex-row-reverse">
            <button type="button" class="btn btn-success  btn-lg" data-toggle="modal" data-target="#exampleModalLong">
                <span class="oi oi-plus" aria-hidden="true"></span> Crear Producto
            </button>
        </div>
        <br /><br /><br />
        <div class="row bg-light">
            <table class="table table-bordered">
                <thead class="thead-dark">
                    <tr>
                        <th>Imagen</th>
                        <th>Nombre</th>
                        <th>Descripci칩n</th>
                        <th>Precio</th>
                        <th>Servicio</th>
                        <th>Cantidad</th>
                        <th>Ver mas Detalle</th>
                    </tr>
                </thead>
                <tbody>
                    @if (productos.Any())
                    {
                        @foreach (var producto in productos)
                        {
                    <tr>
                    <td><img src="@producto.img" width="100" height="100" ></td>
                        <td>@producto.Nombre</td>
                        <td>@producto.Descripcion</td>
                        <td>@producto.Precio</td>
                        <td>@producto.Servicio</td>
                        <td>@producto.Cantidad</td>
                          <td><button class="btn btn-primary" @onclick="(() => Navegar(producto))">View</button></td>
                        <td>
                            @* <button class="btn btn-info" data-toggle="modal" data-target="#editModalLong" @onclick="(() => SetSecretoForUpdate(secreto))">Editar</button> *@
                            @* <button class="btn btn-danger" @onclick="(() => DeleteSecreto(secreto))">Eliminar</button> *@
                        </td>

                    </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="6"><strong>No hay producto creado</strong></td></tr>
                    }
                </tbody>
            </table>
        </div>


        @* MODAL Crear*@
        <div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle">Creaci칩n de Producto</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="col-md-10 mx-auto py-4">
                            <form>
                                <div class="form-group">
                                    <label for="titulo">Nombre</label>
                                    <input type="text" id="titulo" class="form-control" @bind="@NewProducto.Nombre" required />
                                </div>
                                  <div class="form-group">
                                    <label for="descripcion">Descripci칩n</label>
                                    <textarea type="text" id="descripcion" class="form-control" @bind="@NewProducto.Descripcion" required />
                                </div>
                                <div class="form-group">
                                    <label for="precio"> Precio</label>
                                    <input type="number" id="precio" class="form-control" @bind="@NewProducto.Precio" required />
                                </div>
                                <div class="form-group">
                                    <label for="servicio">Servicio</label>
                                    <input type="checkbox" id="servicio" class="form-control" @bind="@NewProducto.Servicio" required />
                                </div>
                                  <div class="form-group">
                                    <label for="cantidad">Cantidad</label>
                                    <input type="number" id="cantidad" class="form-control" @bind="@NewProducto.Cantidad" required />
                                </div>
                               <div class="form-group">
                                <label for="nombre">Pruebas gr치ficas(s)</label>
                                <InputFile OnChange="HandleSelectImagen"></InputFile>
                                </div>
                            

                                <div class="text-center p-3 mb-3">
                                    <button class="btn btn-info" @onclick="AddNewProducto"> Agregar </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        @* MODAL Editar*@
        @* <div class="modal fade" id="editModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle">Editar Secreto</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="col-md-10 mx-auto py-4">
                            <form>
                                <div class="form-group">
                                    <label for="titulo">Titulo</label>
                                    <input type="text" id="titulo" class="form-control" @bind="@ProductoUpdate.Nombre" required />
                                </div>
                                <div class="form-group">
                                    <label for="fecha"> Fecha</label>
                                    <input type="date" id="fecha" class="form-control" @bind="@ProductoUpdate.Fecha" required />
                                </div>
                                <div class="form-group">
                                    <label for="valor_monetario">Valor Monetario</label>
                                    <input type="number" id="valor_monetario" class="form-control" @bind="@UpdateSecreto.Valor_Monetario" required />
                                </div>
                                <div class="form-group">
                                    <label for="lugar">Lugar</label>
                                    <input type="text" id="lugar" class="form-control" @bind="@UpdateSecreto.Lugar" required />
                                </div>
                                <div class="form-group">
                                    <label for="peso">Peso</label>
                                    <input type="number" id="peso" class="form-control" @bind="@UpdateSecreto.Peso" required />
                                </div>
                                <div class="form-group">
                                    <label for="quantity">Descripcion</label>
                                    <textarea type="text" id="descripcion" class="form-control" @bind="@UpdateSecreto.Descripcion" required />
                                </div>
                                <div class="form-group">
                                    <label for="URL">URL</label>
                                    <input type="text" id="URL" class="form-control" @bind="@UpdateSecreto.Url" />
                                </div>
                                <div class="form-group">
                                    <label for="Description">Latitud</label>
                                    <input type="text" id="Description" class="form-control" @bind="@UpdateSecreto.Lat" required />
                                </div>
                                <div class="form-group">
                                    <label for="Description">Longitud</label>
                                    <input type="text" id="Description" class="form-control" @bind="@UpdateSecreto.Lng" required />
                                </div>

                                <div class="text-center p-3 mb-3">
                                    <button class="btn btn-info" @onclick="UpdateProductoData"> Editar Secreto</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div> *@

    </Authorized>
    <NotAuthorized>
        <center>
            <h1>Lo Siento necesita esta logueado</h1>
            <br /><br />
            <p>
                Necesita entrar con tu usuario
            </p>
        </center>

    </NotAuthorized>
</AuthorizeView>

@code {
    public string name_search;
    Usuario usuario1;
    List<Producto> productos = new List<Producto>();
    IFileListEntry image;
     async Task HandleSelectImagen(IFileListEntry[] images ){
Console.WriteLine("productos",images.FirstOrDefault());
        image = images.FirstOrDefault();
        Console.WriteLine(image);
        

    }
    protected override async Task OnInitializedAsync()
    {
        name_search = httpContextAccessor.HttpContext.User.Identity.Name;
        await Refresh();
    }
      private void Navegar(Producto producto)
    {
        NavigationManager.NavigateTo("/Producto/" + producto.ProductoID);
    }

    private async Task Refresh()
    {
        productos = await service.GetProductoAsync();
        usuario1 = await service_usuario.getInformation(name_search);
    }


    public Producto NewProducto { get; set; } = new Producto();
    private async Task AddNewProducto()
    {
        await service.AddProductoAsync(NewProducto,image);
        NewProducto = new Producto();
        await Refresh();
    }
    Producto ProductoUpdate = new Producto();
    private void SetProductoForUpdate(Producto producto)
    {
        ProductoUpdate = producto;
    }
    private async Task UpdateProductoData()
    {
        await service.UpdateProductoAsync(ProductoUpdate);
        await Refresh();
    }


}
